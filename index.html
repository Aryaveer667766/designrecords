<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DesignTrack Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-50 z-50 flex flex-col items-center justify-center p-4 text-center">
        <div id="loading-content">
            <i data-lucide="database" class="w-12 h-12 text-indigo-600 mb-4 animate-bounce mx-auto"></i>
            <p class="text-indigo-900 font-medium">Loading your records...</p>
            <p class="text-xs text-gray-400 mt-2">Connecting to Realtime Database...</p>
        </div>
    </div>

    <!-- Error Modal (For Permission Issues) -->
    <div id="error-modal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-90 z-[60] flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 text-center relative">
            <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i data-lucide="lock" class="w-8 h-8 text-red-600"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-2">Database Locked</h3>
            <p class="text-gray-600 mb-4 text-sm">
                Your Firebase Realtime Database rules are set to private, so the app cannot save data online.
            </p>
            
            <div class="flex flex-col space-y-3">
                <button onclick="app.enableOfflineMode()" class="w-full bg-gray-100 text-gray-800 py-3 rounded-lg font-semibold hover:bg-gray-200 transition border border-gray-300 flex items-center justify-center">
                    <i data-lucide="wifi-off" class="w-4 h-4 mr-2"></i>
                    Use Offline Mode (Local Storage)
                </button>
                
                <div class="relative py-2">
                    <div class="absolute inset-0 flex items-center">
                        <div class="w-full border-t border-gray-300"></div>
                    </div>
                    <div class="relative flex justify-center text-sm">
                        <span class="px-2 bg-white text-gray-500">OR FIX DATABASE</span>
                    </div>
                </div>

                <div class="text-left bg-gray-50 p-3 rounded-lg border border-gray-200 text-xs">
                    <p class="font-bold text-gray-500 mb-1">To enable online sync:</p>
                    <p class="mb-1">1. Go to Firebase Console > Realtime Database > Rules</p>
                    <p class="mb-2">2. Set rules to <code>true</code>:</p>
                    <pre class="bg-gray-800 text-green-400 p-2 rounded font-mono overflow-x-auto">{ "rules": { ".read": true, ".write": true } }</pre>
                </div>
                
                <button onclick="location.reload()" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition shadow-md">
                    I've Updated Rules, Retry
                </button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <nav class="bg-indigo-700 text-white shadow-lg sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i data-lucide="layout" class="h-8 w-8 opacity-90"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-wide leading-tight flex items-center">
                        DesignTrack Pro
                        <span id="offline-badge" class="hidden ml-2 px-2 py-0.5 rounded text-[10px] bg-gray-800 text-gray-300 border border-gray-600 uppercase tracking-wider">Offline</span>
                    </h1>
                    <p class="text-xs text-indigo-200 font-light">Company Records</p>
                </div>
            </div>
            <div class="flex space-x-2">
                <button onclick="app.downloadCSV()" class="hidden sm:flex bg-indigo-600 text-white border border-indigo-500 px-4 py-2 rounded-lg font-medium items-center hover:bg-indigo-500 transition shadow-sm">
                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                    Export
                </button>
                <button onclick="app.openModal()" class="bg-white text-indigo-700 px-4 py-2 rounded-lg font-medium flex items-center hover:bg-indigo-50 transition shadow-sm">
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                    New Record
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Stats Grid -->
        <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Populated by JS -->
        </div>

        <!-- Controls -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6">
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
                <!-- Search -->
                <div class="relative w-full md:w-1/3">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                    <input type="text" id="search-input" placeholder="Search clients..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>

                <!-- Filter Tabs -->
                <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0 no-scrollbar" id="filter-tabs">
                    <!-- Populated by JS -->
                </div>

                <!-- Sort -->
                <div class="relative w-full md:w-auto min-w-[150px]">
                    <i data-lucide="arrow-up-down" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                    <select id="sort-select" class="w-full pl-9 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none appearance-none bg-white text-sm">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="due_soon">Due Date (Soonest)</option>
                        <option value="progress">Progress (Low to High)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Project List -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div id="empty-state" class="hidden p-12 text-center text-gray-400 flex-col items-center">
                <i data-lucide="briefcase" class="w-16 h-16 mb-4 opacity-20 mx-auto"></i>
                <p class="text-lg">No records found.</p>
                <p class="text-sm">Create a new record to get started.</p>
            </div>
            
            <div id="table-container" class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase tracking-wider text-gray-500 font-semibold">
                            <th class="px-6 py-4">Client / Project</th>
                            <th class="px-6 py-4">Type</th>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4 w-48">Progress</th>
                            <th class="px-6 py-4 text-right">Financials (₹)</th>
                            <th class="px-6 py-4 text-right">Due Date</th>
                            <th class="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="projects-body" class="divide-y divide-gray-200">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h2 id="modal-title" class="text-lg font-bold text-gray-800 flex items-center">
                    <!-- Dynamic Title -->
                </h2>
                <button onclick="app.closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="project-form" class="p-6 overflow-y-auto">
                <input type="hidden" id="edit-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Client Info -->
                    <div class="space-y-4">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Client Details</h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                            <div class="relative">
                                <i data-lucide="user" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                                <input required type="text" id="clientName" class="pl-10 w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" placeholder="e.g. ABC Corp">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                            <input required type="text" id="projectName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" placeholder="e.g. Brochure Design">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Project Type</label>
                            <select id="projectType" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none bg-white">
                                <option>Social Media</option>
                                <option>Logo / Branding</option>
                                <option>Print / Flyer</option>
                                <option>Web Design</option>
                                <option>UI/UX</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="status" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none bg-white">
                                <option>Pending</option>
                                <option>In Progress</option>
                                <option>Review</option>
                                <option>Completed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Financials & Scope -->
                    <div class="space-y-4">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Scope & Financials</h3>
                        
                        <!-- Page Count Logic -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Total Pages</label>
                                <input type="number" min="1" id="totalPages" value="1" oninput="app.updateCalc()" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Pages Done</label>
                                <input type="number" min="0" id="pagesCreated" value="0" oninput="app.updateCalc()" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none bg-green-50 border-green-200">
                            </div>
                        </div>

                        <div class="flex justify-between items-center text-xs bg-gray-50 p-2 rounded border border-gray-200">
                            <span class="text-gray-500">Progress:</span>
                            <span id="calc-pages-info" class="font-bold text-gray-700">0 / 1 (1 Remaining)</span>
                        </div>

                        <div class="pt-2">
                            <label class="block text-sm font-medium text-gray-700 mb-1">Price / Page (₹)</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500">₹</span>
                                <input type="number" min="0" step="0.01" id="pricePerPage" value="0" oninput="app.updateCalc()" class="pl-7 w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Advance Paid</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500">₹</span>
                                <input type="number" min="0" step="0.01" id="advancePaid" value="0" oninput="app.updateCalc()" class="pl-7 w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                            </div>
                        </div>
                        
                        <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mt-2">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-600">Total Cost:</span>
                                <span id="calc-total" class="font-bold text-indigo-900">₹0</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Remaining Payment:</span>
                                <span id="calc-remaining" class="font-bold text-indigo-900">₹0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-gray-100 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input type="date" id="dueDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <input type="text" id="notes" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" placeholder="Additional details...">
                    </div>
                </div>

                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" onclick="app.closeModal()" class="px-5 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition">Cancel</button>
                    <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 shadow-md transition flex items-center">
                        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                        Save Record
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getDatabase, ref, push, set, update, remove, onValue, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js';

        // --- CONFIGURATION ---
        let firebaseConfig;
        try {
            if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                firebaseConfig = JSON.parse(__firebase_config);
            } else {
                throw new Error('Environment config missing');
            }
        } catch (e) {
            // FALLBACK TO USER CONFIG
            firebaseConfig = {
                apiKey: "AIzaSyBHyyUHxcoTfTCSPeO8QI-StUoqvsbRpFw",
                authDomain: "designsnap-3538d.firebaseapp.com",
                databaseURL: "https://designsnap-3538d-default-rtdb.asia-southeast1.firebasedatabase.app",
                projectId: "designsnap-3538d",
                storageBucket: "designsnap-3538d.firebasestorage.app",
                messagingSenderId: "42045980632",
                appId: "1:42045980632:web:e16d0751deef50b8137cad",
                measurementId: "G-DH3Z2K7JYY"
            };
        }

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const rawAppId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const appId = rawAppId.replace(/[.#$\[\]]/g, '_');

        // --- Helper: Get/Create Local User ID ---
        function getLocalUserId() {
            const STORAGE_KEY = 'design_track_local_uid';
            let uid = localStorage.getItem(STORAGE_KEY);
            if (!uid) {
                uid = 'user_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
                localStorage.setItem(STORAGE_KEY, uid);
            }
            return uid;
        }

        // --- State ---
        const state = {
            userId: getLocalUserId(),
            projects: [],
            filter: 'All',
            sort: 'newest',
            search: '',
            editingId: null,
            isOffline: false // Track if we are in offline mode
        };

        // --- App Logic ---
        const App = {
            init: async () => {
                App.subscribeToData();

                document.getElementById('search-input').addEventListener('input', (e) => {
                    state.search = e.target.value;
                    App.renderTable();
                });

                document.getElementById('sort-select').addEventListener('change', (e) => {
                    state.sort = e.target.value;
                    App.renderTable();
                });

                document.getElementById('project-form').addEventListener('submit', App.handleSave);
            },

            enableOfflineMode: () => {
                state.isOffline = true;
                document.getElementById('error-modal').classList.add('hidden');
                document.getElementById('offline-badge').classList.remove('hidden');
                App.loadLocalData();
            },

            loadLocalData: () => {
                // Load from Local Storage
                const localKey = `dt_local_${state.userId}`;
                const localData = JSON.parse(localStorage.getItem(localKey) || '[]');
                state.projects = localData;
                App.renderStats();
                App.renderTable();
                App.renderFilters();
                document.getElementById('loading-screen').style.display = 'none';
                lucide.createIcons();
            },

            subscribeToData: () => {
                // Try Cloud connection first
                const projectsRef = ref(db, `artifacts/${appId}/users/${state.userId}/design_projects`);
                
                onValue(projectsRef, (snapshot) => {
                    if (state.isOffline) return; // Ignore updates if offline mode selected

                    const data = snapshot.val();
                    if (data) {
                        state.projects = Object.keys(data).map(key => ({
                            id: key,
                            ...data[key]
                        }));
                    } else {
                        state.projects = [];
                    }

                    App.renderStats();
                    App.renderTable();
                    App.renderFilters();
                    document.getElementById('loading-screen').style.display = 'none';
                }, (error) => {
                    console.error("DB error:", error);
                    // Check for Permission Denied
                    const errStr = (error.code || '') + (error.message || '');
                    if (errStr.toLowerCase().includes('permission_denied') || errStr.toLowerCase().includes('permission denied')) {
                        document.getElementById('loading-screen').style.display = 'none';
                        document.getElementById('error-modal').classList.remove('hidden');
                        lucide.createIcons();
                    }
                });
            },

            // --- Calculation Helpers ---
            calcFinancials: (pages, rate, advance) => {
                const total = (parseFloat(pages) || 0) * (parseFloat(rate) || 0);
                const remaining = total - (parseFloat(advance) || 0);
                return { total, remaining };
            },

            // --- Rendering ---
            renderStats: () => {
                const stats = state.projects.reduce((acc, curr) => {
                    const { total, remaining } = App.calcFinancials(curr.totalPages, curr.pricePerPage, curr.advancePaid);
                    const pagesCreated = parseInt(curr.pagesCreated) || 0;
                    
                    acc.totalRevenue += total;
                    acc.totalOutstanding += remaining;
                    acc.pagesCreated += pagesCreated; // Actual pages made
                    acc.activeProjects += (curr.status !== 'Completed' ? 1 : 0);
                    return acc;
                }, { totalRevenue: 0, totalOutstanding: 0, pagesCreated: 0, activeProjects: 0 });

                const statsHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-500">Total Revenue</h3>
                            <i data-lucide="indian-rupee" class="w-5 h-5 text-green-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-gray-900">₹${stats.totalRevenue.toLocaleString('en-IN')}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-500">Outstanding</h3>
                            <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-red-600">₹${stats.totalOutstanding.toLocaleString('en-IN')}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-500">Active Projects</h3>
                            <i data-lucide="briefcase" class="w-5 h-5 text-indigo-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-gray-900">${stats.activeProjects}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-500">Total Pages Made</h3>
                            <i data-lucide="file-text" class="w-5 h-5 text-blue-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-gray-900">${stats.pagesCreated}</p>
                    </div>
                `;
                document.getElementById('stats-grid').innerHTML = statsHtml;
                lucide.createIcons();
            },

            renderFilters: () => {
                const filters = ['All', 'In Progress', 'Pending', 'Review', 'Completed'];
                const html = filters.map(f => `
                    <button onclick="app.setFilter('${f}')" class="px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition ${state.filter === f ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                        ${f}
                    </button>
                `).join('');
                document.getElementById('filter-tabs').innerHTML = html;
            },

            renderTable: () => {
                const filtered = state.projects.filter(p => {
                    const matchSearch = (p.clientName || '').toLowerCase().includes(state.search.toLowerCase()) || 
                                      (p.projectName || '').toLowerCase().includes(state.search.toLowerCase());
                    const matchFilter = state.filter === 'All' || p.status === state.filter;
                    return matchSearch && matchFilter;
                }).sort((a, b) => {
                    const dateA = a.createdAt || 0;
                    const dateB = b.createdAt || 0;
                    
                    if (state.sort === 'newest') return dateB - dateA;
                    if (state.sort === 'oldest') return dateA - dateB;
                    if (state.sort === 'due_soon') {
                        if (!a.dueDate) return 1;
                        if (!b.dueDate) return -1;
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    }
                    if (state.sort === 'progress') {
                         const progA = (a.pagesCreated || 0) / (a.totalPages || 1);
                         const progB = (b.pagesCreated || 0) / (b.totalPages || 1);
                         return progA - progB;
                    }
                    return 0;
                });

                if (filtered.length === 0) {
                    document.getElementById('table-container').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                    document.getElementById('empty-state').classList.add('flex');
                } else {
                    document.getElementById('table-container').classList.remove('hidden');
                    document.getElementById('empty-state').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('flex');
                }

                const tbody = document.getElementById('projects-body');
                tbody.innerHTML = filtered.map(p => {
                    const { total, remaining } = App.calcFinancials(p.totalPages, p.pricePerPage, p.advancePaid);
                    
                    let dateClass = 'text-gray-600';
                    if (p.dueDate) {
                        const diff = Math.ceil((new Date(p.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                        if (diff < 0) dateClass = 'text-red-600 font-bold';
                        else if (diff <= 3) dateClass = 'text-orange-600 font-semibold';
                    }

                    const statusStyles = {
                        'Completed': 'bg-green-100 text-green-800 border-green-200',
                        'In Progress': 'bg-blue-100 text-blue-800 border-blue-200',
                        'Pending': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                        'Review': 'bg-purple-100 text-purple-800 border-purple-200'
                    };

                    const pagesCreated = parseInt(p.pagesCreated) || 0;
                    const totalPages = parseInt(p.totalPages) || 1;
                    const percent = Math.min(100, Math.round((pagesCreated / totalPages) * 100));
                    const pagesLeft = Math.max(0, totalPages - pagesCreated);

                    return `
                        <tr class="hover:bg-gray-50 transition group">
                            <td class="px-6 py-4">
                                <div class="flex flex-col">
                                    <span class="font-bold text-gray-900">${p.clientName}</span>
                                    <span class="text-sm text-gray-500">${p.projectName}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded border border-gray-200">${p.projectType || 'Other'}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-2.5 py-0.5 rounded-full text-xs font-medium border ${statusStyles[p.status] || 'bg-gray-100'}">${p.status}</span>
                            </td>
                            <td class="px-6 py-4 align-middle">
                                <div class="w-full max-w-[140px]">
                                    <div class="flex justify-between text-xs mb-1 font-medium">
                                        <span class="text-indigo-900">${pagesCreated} / ${totalPages}</span>
                                        <span class="text-gray-400">${pagesLeft} left</span>
                                    </div>
                                    <div class="h-2 bg-gray-200 rounded-full overflow-hidden">
                                        <div class="h-full bg-indigo-500 transition-all duration-500 ease-out" style="width: ${percent}%"></div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex flex-col items-end">
                                    <span class="text-sm font-medium text-gray-900">Total: ₹${total.toLocaleString('en-IN')}</span>
                                    ${remaining > 0 
                                        ? `<span class="text-xs font-bold text-red-600 bg-red-50 px-1.5 rounded mt-1 border border-red-100">Due: ₹${remaining.toLocaleString('en-IN')}</span>`
                                        : `<span class="text-xs font-bold text-green-600 bg-green-50 px-1.5 rounded mt-1 border border-green-100">Paid Full</span>`
                                    }
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right text-sm ${dateClass}">
                                ${p.dueDate ? new Date(p.dueDate).toLocaleDateString() : '-'}
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex justify-end space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="app.editProject('${p.id}')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-full"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                    <button onclick="app.deleteProject('${p.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                lucide.createIcons();
            },

            setFilter: (f) => {
                state.filter = f;
                App.renderFilters();
                App.renderTable();
            },

            openModal: () => {
                document.getElementById('project-form').reset();
                document.getElementById('edit-id').value = '';
                document.getElementById('modal-title').innerHTML = '<i data-lucide="plus" class="w-5 h-5 mr-2 text-indigo-600"></i> New Project Record';
                document.getElementById('modal').classList.remove('hidden');
                // Reset defaults
                document.getElementById('totalPages').value = 1;
                document.getElementById('pagesCreated').value = 0;
                App.updateCalc();
                lucide.createIcons();
            },

            closeModal: () => {
                document.getElementById('modal').classList.add('hidden');
                state.editingId = null;
            },

            editProject: (id) => {
                const p = state.projects.find(project => project.id === id);
                if (!p) return;

                document.getElementById('edit-id').value = p.id;
                document.getElementById('clientName').value = p.clientName;
                document.getElementById('projectName').value = p.projectName;
                document.getElementById('projectType').value = p.projectType || 'Social Media';
                document.getElementById('status').value = p.status;
                
                document.getElementById('totalPages').value = p.totalPages;
                document.getElementById('pagesCreated').value = p.pagesCreated || 0; // Load new field
                
                document.getElementById('pricePerPage').value = p.pricePerPage;
                document.getElementById('advancePaid').value = p.advancePaid;
                document.getElementById('dueDate').value = p.dueDate || '';
                document.getElementById('notes').value = p.notes || '';

                document.getElementById('modal-title').innerHTML = '<i data-lucide="edit-2" class="w-5 h-5 mr-2 text-indigo-600"></i> Edit Record';
                document.getElementById('modal').classList.remove('hidden');
                App.updateCalc();
                lucide.createIcons();
            },

            deleteProject: async (id) => {
                if (confirm('Are you sure you want to delete this record?')) {
                    if (state.isOffline) {
                        const localKey = `dt_local_${state.userId}`;
                        const localData = JSON.parse(localStorage.getItem(localKey) || '[]');
                        const newData = localData.filter(p => p.id !== id);
                        localStorage.setItem(localKey, JSON.stringify(newData));
                        state.projects = newData;
                        App.renderTable();
                        App.renderStats();
                        return;
                    }

                    try {
                        const projectRef = ref(db, `artifacts/${appId}/users/${state.userId}/design_projects/${id}`);
                        await remove(projectRef);
                    } catch (err) {
                        console.error(err);
                    }
                }
            },

            updateCalc: () => {
                const pages = parseFloat(document.getElementById('totalPages').value) || 0;
                const pagesDone = parseFloat(document.getElementById('pagesCreated').value) || 0;
                const rate = document.getElementById('pricePerPage').value;
                const advance = document.getElementById('advancePaid').value;
                
                const { total, remaining } = App.calcFinancials(pages, rate, advance);
                
                // Update Money
                document.getElementById('calc-total').innerText = `₹${total.toLocaleString('en-IN')}`;
                document.getElementById('calc-remaining').innerText = `₹${remaining.toLocaleString('en-IN')}`;

                // Update Page Logic info
                const pagesLeft = Math.max(0, pages - pagesDone);
                document.getElementById('calc-pages-info').innerText = `${pagesDone} / ${pages} (${pagesLeft} Remaining)`;
            },

            handleSave: async (e) => {
                e.preventDefault();
                const editingId = document.getElementById('edit-id').value;
                const data = {
                    clientName: document.getElementById('clientName').value,
                    projectName: document.getElementById('projectName').value,
                    projectType: document.getElementById('projectType').value,
                    status: document.getElementById('status').value,
                    totalPages: parseInt(document.getElementById('totalPages').value) || 0,
                    pagesCreated: parseInt(document.getElementById('pagesCreated').value) || 0, // Save new field
                    pricePerPage: parseFloat(document.getElementById('pricePerPage').value) || 0,
                    advancePaid: parseFloat(document.getElementById('advancePaid').value) || 0,
                    dueDate: document.getElementById('dueDate').value,
                    notes: document.getElementById('notes').value,
                    updatedAt: Date.now()
                };

                if (state.isOffline) {
                    const localKey = `dt_local_${state.userId}`;
                    const localData = JSON.parse(localStorage.getItem(localKey) || '[]');
                    
                    if (editingId) {
                        const idx = localData.findIndex(p => p.id === editingId);
                        if (idx !== -1) {
                            localData[idx] = { ...localData[idx], ...data };
                        }
                    } else {
                        data.id = 'local_' + Date.now();
                        localData.push(data);
                    }
                    localStorage.setItem(localKey, JSON.stringify(localData));
                    state.projects = localData;
                    App.renderTable();
                    App.renderStats();
                    App.renderFilters();
                    App.closeModal();
                    return;
                }

                // Firebase Logic
                try {
                    if (editingId) {
                        const projectRef = ref(db, `artifacts/${appId}/users/${state.userId}/design_projects/${editingId}`);
                        await update(projectRef, data);
                    } else {
                        const projectsRef = ref(db, `artifacts/${appId}/users/${state.userId}/design_projects`);
                        const newRef = push(projectsRef);
                        await set(newRef, data);
                    }
                    App.closeModal();
                } catch (err) {
                    console.error("Save error", err);
                }
            },

            downloadCSV: () => {
                const headers = ["Client Name", "Project", "Type", "Status", "Pages Done", "Total Pages", "Remaining Pages", "Price/Page", "Total Cost", "Advance", "Remaining Balance", "Due Date"];
                const csvData = state.projects.map(p => {
                    const { total, remaining } = App.calcFinancials(p.totalPages, p.pricePerPage, p.advancePaid);
                    const pagesDone = p.pagesCreated || 0;
                    const pagesLeft = Math.max(0, p.totalPages - pagesDone);

                    return [
                        `"${p.clientName}"`, `"${p.projectName}"`, `"${p.projectType || '-'}"`,
                        p.status, pagesDone, p.totalPages, pagesLeft, p.pricePerPage, total, p.advancePaid, remaining, p.dueDate || '-'
                    ].join(",");
                });

                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...csvData].join("\n");
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "design_records.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        window.app = App;
        App.init();
    </script>
</body>
</html>
