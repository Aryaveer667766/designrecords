<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DesignTrack Pro</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Loading Spinner */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #4f46e5;
            width: 24px;
            height: 24px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-gray-50 z-50 flex flex-col items-center justify-center">
        <i data-lucide="indian-rupee" class="w-12 h-12 text-indigo-600 mb-4 animate-bounce"></i>
        <p class="text-indigo-900 font-medium">Loading your records...</p>
        <p class="text-xs text-gray-400 mt-2">Connecting to secure storage...</p>
    </div>

    <!-- Navbar -->
    <nav class="bg-indigo-700 text-white shadow-lg sticky top-0 z-30">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <i data-lucide="layout" class="h-8 w-8 opacity-90"></i>
                <div>
                    <h1 class="text-xl font-bold tracking-wide leading-tight">DesignTrack Pro</h1>
                    <p class="text-xs text-indigo-200 font-light">Company Records</p>
                </div>
            </div>
            <div class="flex space-x-2">
                <button onclick="app.downloadCSV()" class="hidden sm:flex bg-indigo-600 text-white border border-indigo-500 px-4 py-2 rounded-lg font-medium items-center hover:bg-indigo-500 transition shadow-sm">
                    <i data-lucide="download" class="w-4 h-4 mr-2"></i>
                    Export
                </button>
                <button onclick="app.openModal()" class="bg-white text-indigo-700 px-4 py-2 rounded-lg font-medium flex items-center hover:bg-indigo-50 transition shadow-sm">
                    <i data-lucide="plus" class="w-4 h-4 mr-2"></i>
                    New Record
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Stats Grid -->
        <div id="stats-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Populated by JS -->
        </div>

        <!-- Controls -->
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6">
            <div class="flex flex-col md:flex-row gap-4 justify-between items-center">
                <!-- Search -->
                <div class="relative w-full md:w-1/3">
                    <i data-lucide="search" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"></i>
                    <input type="text" id="search-input" placeholder="Search clients..." class="w-full pl-10 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none transition">
                </div>

                <!-- Filter Tabs -->
                <div class="flex gap-2 w-full md:w-auto overflow-x-auto pb-2 md:pb-0 no-scrollbar" id="filter-tabs">
                    <!-- Populated by JS -->
                </div>

                <!-- Sort -->
                <div class="relative w-full md:w-auto min-w-[150px]">
                    <i data-lucide="arrow-up-down" class="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-4 h-4"></i>
                    <select id="sort-select" class="w-full pl-9 pr-4 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none appearance-none bg-white text-sm">
                        <option value="newest">Newest First</option>
                        <option value="oldest">Oldest First</option>
                        <option value="due_soon">Due Date (Soonest)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Project List -->
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div id="empty-state" class="hidden p-12 text-center text-gray-400 flex-col items-center">
                <i data-lucide="briefcase" class="w-16 h-16 mb-4 opacity-20 mx-auto"></i>
                <p class="text-lg">No records found.</p>
                <p class="text-sm">Create a new record to get started.</p>
            </div>
            
            <div id="table-container" class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead>
                        <tr class="bg-gray-50 border-b border-gray-200 text-xs uppercase tracking-wider text-gray-500 font-semibold">
                            <th class="px-6 py-4">Client / Project</th>
                            <th class="px-6 py-4">Type</th>
                            <th class="px-6 py-4">Status</th>
                            <th class="px-6 py-4 text-right">Pages</th>
                            <th class="px-6 py-4 text-right">Financials (₹)</th>
                            <th class="px-6 py-4 text-right">Due Date</th>
                            <th class="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="projects-body" class="divide-y divide-gray-200">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h2 id="modal-title" class="text-lg font-bold text-gray-800 flex items-center">
                    <!-- Dynamic Title -->
                </h2>
                <button onclick="app.closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <form id="project-form" class="p-6 overflow-y-auto">
                <input type="hidden" id="edit-id">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Client Info -->
                    <div class="space-y-4">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Client Details</h3>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Client Name</label>
                            <div class="relative">
                                <i data-lucide="user" class="absolute left-3 top-2.5 text-gray-400 w-4 h-4"></i>
                                <input required type="text" id="clientName" class="pl-10 w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" placeholder="e.g. ABC Corp">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Project Name</label>
                            <input required type="text" id="projectName" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" placeholder="e.g. Brochure Design">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Project Type</label>
                            <select id="projectType" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none bg-white">
                                <option>Social Media</option>
                                <option>Logo / Branding</option>
                                <option>Print / Flyer</option>
                                <option>Web Design</option>
                                <option>UI/UX</option>
                                <option>Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                            <select id="status" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none bg-white">
                                <option>Pending</option>
                                <option>In Progress</option>
                                <option>Review</option>
                                <option>Completed</option>
                            </select>
                        </div>
                    </div>

                    <!-- Financials -->
                    <div class="space-y-4">
                        <h3 class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Financials (₹)</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Total Pages</label>
                                <input type="number" min="0" id="totalPages" value="1" oninput="app.updateCalc()" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Price / Page</label>
                                <div class="relative">
                                    <span class="absolute left-3 top-2 text-gray-500">₹</span>
                                    <input type="number" min="0" step="1" id="pricePerPage" value="0" oninput="app.updateCalc()" class="pl-7 w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Advance Paid</label>
                            <div class="relative">
                                <span class="absolute left-3 top-2 text-gray-500">₹</span>
                                <input type="number" min="0" step="1" id="advancePaid" value="0" oninput="app.updateCalc()" class="pl-7 w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                            </div>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg border border-indigo-100 mt-2">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="text-gray-600">Total Cost:</span>
                                <span id="calc-total" class="font-bold text-indigo-900">₹0</span>
                            </div>
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Remaining:</span>
                                <span id="calc-remaining" class="font-bold text-indigo-900">₹0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 pt-6 border-t border-gray-100 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Due Date</label>
                        <input type="date" id="dueDate" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Notes</label>
                        <input type="text" id="notes" class="w-full border border-gray-300 rounded-lg px-3 py-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none" placeholder="Additional details...">
                    </div>
                </div>

                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" onclick="app.closeModal()" class="px-5 py-2 border border-gray-300 text-gray-700 rounded-lg font-medium hover:bg-gray-50 transition">Cancel</button>
                    <button type="submit" class="px-5 py-2 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 shadow-md transition flex items-center">
                        <i data-lucide="save" class="w-4 h-4 mr-2"></i>
                        Save Record
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithCustomToken } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, query, serverTimestamp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        // --- Config ---
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- State ---
        const state = {
            user: null,
            projects: [],
            filter: 'All',
            sort: 'newest',
            search: '',
            editingId: null
        };

        // --- App Logic ---
        const App = {
            init: async () => {
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (err) {
                    console.error("Auth error:", err);
                }

                onAuthStateChanged(auth, (user) => {
                    state.user = user;
                    if (user) {
                        App.subscribeToData();
                    } else {
                        document.getElementById('loading-screen').style.display = 'none';
                    }
                });

                // Event Listeners
                document.getElementById('search-input').addEventListener('input', (e) => {
                    state.search = e.target.value;
                    App.renderTable();
                });

                document.getElementById('sort-select').addEventListener('change', (e) => {
                    state.sort = e.target.value;
                    App.renderTable();
                });

                document.getElementById('project-form').addEventListener('submit', App.handleSave);
            },

            subscribeToData: () => {
                const q = query(collection(db, 'artifacts', appId, 'users', state.user.uid, 'design_projects'));
                onSnapshot(q, (snapshot) => {
                    state.projects = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    App.renderStats();
                    App.renderTable();
                    App.renderFilters();
                    document.getElementById('loading-screen').style.display = 'none';
                }, (error) => {
                    console.error("Firestore error:", error);
                    document.getElementById('loading-screen').style.display = 'none';
                });
            },

            // --- Calculation Helpers ---
            calcFinancials: (pages, rate, advance) => {
                const total = (parseFloat(pages) || 0) * (parseFloat(rate) || 0);
                const remaining = total - (parseFloat(advance) || 0);
                return { total, remaining };
            },

            // --- Rendering ---
            renderStats: () => {
                const stats = state.projects.reduce((acc, curr) => {
                    const { total, remaining } = App.calcFinancials(curr.totalPages, curr.pricePerPage, curr.advancePaid);
                    acc.totalRevenue += total;
                    acc.totalOutstanding += remaining;
                    acc.totalPages += parseInt(curr.totalPages) || 0;
                    acc.activeProjects += (curr.status !== 'Completed' ? 1 : 0);
                    return acc;
                }, { totalRevenue: 0, totalOutstanding: 0, totalPages: 0, activeProjects: 0 });

                const statsHtml = `
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-500">Total Revenue</h3>
                            <i data-lucide="indian-rupee" class="w-5 h-5 text-green-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-gray-900">₹${stats.totalRevenue.toLocaleString('en-IN')}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-500">Outstanding</h3>
                            <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-red-600">₹${stats.totalOutstanding.toLocaleString('en-IN')}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-500">Active Projects</h3>
                            <i data-lucide="briefcase" class="w-5 h-5 text-indigo-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-gray-900">${stats.activeProjects}</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-medium text-gray-500">Total Pages Made</h3>
                            <i data-lucide="file-text" class="w-5 h-5 text-blue-500"></i>
                        </div>
                        <p class="text-2xl font-bold text-gray-900">${stats.totalPages}</p>
                    </div>
                `;
                document.getElementById('stats-grid').innerHTML = statsHtml;
                lucide.createIcons();
            },

            renderFilters: () => {
                const filters = ['All', 'In Progress', 'Pending', 'Review', 'Completed'];
                const html = filters.map(f => `
                    <button onclick="app.setFilter('${f}')" class="px-3 py-1.5 rounded-lg text-sm font-medium whitespace-nowrap transition ${state.filter === f ? 'bg-indigo-100 text-indigo-700' : 'bg-gray-100 text-gray-600 hover:bg-gray-200'}">
                        ${f}
                    </button>
                `).join('');
                document.getElementById('filter-tabs').innerHTML = html;
            },

            renderTable: () => {
                const filtered = state.projects.filter(p => {
                    const matchSearch = (p.clientName || '').toLowerCase().includes(state.search.toLowerCase()) || 
                                      (p.projectName || '').toLowerCase().includes(state.search.toLowerCase());
                    const matchFilter = state.filter === 'All' || p.status === state.filter;
                    return matchSearch && matchFilter;
                }).sort((a, b) => {
                    if (state.sort === 'newest') return (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0);
                    if (state.sort === 'oldest') return (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0);
                    if (state.sort === 'due_soon') {
                        if (!a.dueDate) return 1;
                        if (!b.dueDate) return -1;
                        return new Date(a.dueDate) - new Date(b.dueDate);
                    }
                    return 0;
                });

                if (filtered.length === 0) {
                    document.getElementById('table-container').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                    document.getElementById('empty-state').classList.add('flex');
                } else {
                    document.getElementById('table-container').classList.remove('hidden');
                    document.getElementById('empty-state').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('flex');
                }

                const tbody = document.getElementById('projects-body');
                tbody.innerHTML = filtered.map(p => {
                    const { total, remaining } = App.calcFinancials(p.totalPages, p.pricePerPage, p.advancePaid);
                    
                    // Urgency Color
                    let dateClass = 'text-gray-600';
                    if (p.dueDate) {
                        const diff = Math.ceil((new Date(p.dueDate) - new Date()) / (1000 * 60 * 60 * 24));
                        if (diff < 0) dateClass = 'text-red-600 font-bold';
                        else if (diff <= 3) dateClass = 'text-orange-600 font-semibold';
                    }

                    // Status Styles
                    const statusStyles = {
                        'Completed': 'bg-green-100 text-green-800 border-green-200',
                        'In Progress': 'bg-blue-100 text-blue-800 border-blue-200',
                        'Pending': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                        'Review': 'bg-purple-100 text-purple-800 border-purple-200'
                    };

                    return `
                        <tr class="hover:bg-gray-50 transition group">
                            <td class="px-6 py-4">
                                <div class="flex flex-col">
                                    <span class="font-bold text-gray-900">${p.clientName}</span>
                                    <span class="text-sm text-gray-500">${p.projectName}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded border border-gray-200">${p.projectType || 'Other'}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="px-2.5 py-0.5 rounded-full text-xs font-medium border ${statusStyles[p.status] || 'bg-gray-100'}">${p.status}</span>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <span class="font-mono text-sm text-gray-700">${p.totalPages}</span>
                                <div class="text-xs text-gray-400">@ ₹${p.pricePerPage}</div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex flex-col items-end">
                                    <span class="text-sm font-medium text-gray-900">Total: ₹${total.toLocaleString('en-IN')}</span>
                                    ${remaining > 0 
                                        ? `<span class="text-xs font-bold text-red-600 bg-red-50 px-1.5 rounded mt-1 border border-red-100">Due: ₹${remaining.toLocaleString('en-IN')}</span>`
                                        : `<span class="text-xs font-bold text-green-600 bg-green-50 px-1.5 rounded mt-1 border border-green-100">Paid Full</span>`
                                    }
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right text-sm ${dateClass}">
                                ${p.dueDate ? new Date(p.dueDate).toLocaleDateString() : '-'}
                            </td>
                            <td class="px-6 py-4 text-right">
                                <div class="flex justify-end space-x-2 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <button onclick="app.editProject('${p.id}')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-full"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                    <button onclick="app.deleteProject('${p.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                </div>
                            </td>
                        </tr>
                    `;
                }).join('');
                lucide.createIcons();
            },

            // --- Actions ---
            setFilter: (f) => {
                state.filter = f;
                App.renderFilters();
                App.renderTable();
            },

            openModal: () => {
                document.getElementById('project-form').reset();
                document.getElementById('edit-id').value = '';
                document.getElementById('modal-title').innerHTML = '<i data-lucide="plus" class="w-5 h-5 mr-2 text-indigo-600"></i> New Project Record';
                document.getElementById('modal').classList.remove('hidden');
                App.updateCalc();
                lucide.createIcons();
            },

            closeModal: () => {
                document.getElementById('modal').classList.add('hidden');
                state.editingId = null;
            },

            editProject: (id) => {
                const p = state.projects.find(project => project.id === id);
                if (!p) return;

                document.getElementById('edit-id').value = p.id;
                document.getElementById('clientName').value = p.clientName;
                document.getElementById('projectName').value = p.projectName;
                document.getElementById('projectType').value = p.projectType || 'Social Media';
                document.getElementById('status').value = p.status;
                document.getElementById('totalPages').value = p.totalPages;
                document.getElementById('pricePerPage').value = p.pricePerPage;
                document.getElementById('advancePaid').value = p.advancePaid;
                document.getElementById('dueDate').value = p.dueDate || '';
                document.getElementById('notes').value = p.notes || '';

                document.getElementById('modal-title').innerHTML = '<i data-lucide="edit-2" class="w-5 h-5 mr-2 text-indigo-600"></i> Edit Record';
                document.getElementById('modal').classList.remove('hidden');
                App.updateCalc();
                lucide.createIcons();
            },

            deleteProject: async (id) => {
                if (confirm('Are you sure you want to delete this record?')) {
                    try {
                        await deleteDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'design_projects', id));
                    } catch (err) {
                        console.error(err);
                    }
                }
            },

            updateCalc: () => {
                const pages = document.getElementById('totalPages').value;
                const rate = document.getElementById('pricePerPage').value;
                const advance = document.getElementById('advancePaid').value;
                const { total, remaining } = App.calcFinancials(pages, rate, advance);
                
                document.getElementById('calc-total').innerText = `₹${total.toLocaleString('en-IN')}`;
                document.getElementById('calc-remaining').innerText = `₹${remaining.toLocaleString('en-IN')}`;
            },

            handleSave: async (e) => {
                e.preventDefault();
                if (!state.user) return;

                const editingId = document.getElementById('edit-id').value;
                const data = {
                    clientName: document.getElementById('clientName').value,
                    projectName: document.getElementById('projectName').value,
                    projectType: document.getElementById('projectType').value,
                    status: document.getElementById('status').value,
                    totalPages: parseInt(document.getElementById('totalPages').value) || 0,
                    pricePerPage: parseFloat(document.getElementById('pricePerPage').value) || 0,
                    advancePaid: parseFloat(document.getElementById('advancePaid').value) || 0,
                    dueDate: document.getElementById('dueDate').value,
                    notes: document.getElementById('notes').value,
                    updatedAt: serverTimestamp()
                };

                try {
                    if (editingId) {
                        await updateDoc(doc(db, 'artifacts', appId, 'users', state.user.uid, 'design_projects', editingId), data);
                    } else {
                        data.createdAt = serverTimestamp();
                        await addDoc(collection(db, 'artifacts', appId, 'users', state.user.uid, 'design_projects'), data);
                    }
                    App.closeModal();
                } catch (err) {
                    console.error("Save error", err);
                }
            },

            downloadCSV: () => {
                const headers = ["Client Name", "Project", "Type", "Status", "Total Pages", "Price/Page", "Total Cost", "Advance", "Remaining", "Due Date"];
                const csvData = state.projects.map(p => {
                    const { total, remaining } = App.calcFinancials(p.totalPages, p.pricePerPage, p.advancePaid);
                    return [
                        `"${p.clientName}"`, `"${p.projectName}"`, `"${p.projectType || '-'}"`,
                        p.status, p.totalPages, p.pricePerPage, total, p.advancePaid, remaining, p.dueDate || '-'
                    ].join(",");
                });

                const csvContent = "data:text/csv;charset=utf-8," + [headers.join(","), ...csvData].join("\n");
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", "design_records.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        // Make functions available globally for HTML onclick attributes
        window.app = App;

        // Initialize
        App.init();
    </script>
</body>
</html>
